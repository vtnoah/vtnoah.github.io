<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Ethernet Controlled Graduated ND Filter &#8211; Noah P. Allen</title>
<meta name="description" content="Problem:

">
<meta name="keywords" content="">


<!-- Twitter Cards -->
<meta name="twitter:title" content="Ethernet Controlled Graduated ND Filter">
<meta name="twitter:description" content="Problem:

">



<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://noaha.net/images/HeadshotSiteLogo.jpg">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Ethernet Controlled Graduated ND Filter">
<meta property="og:description" content="Problem:

">
<meta property="og:url" content="https://noaha.net/blog/SSPC-Controlled-ND-Filter/">
<meta property="og:site_name" content="Noah P. Allen">





<link rel="canonical" href="https://noaha.net/blog/SSPC-Controlled-ND-Filter/">
<link href="https://noaha.net/feed.xml" type="application/atom+xml" rel="alternate" title="Noah P. Allen Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="https://noaha.net/assets/css/main.css">
<!-- Webfonts -->
<script src="https://use.edgefonts.net/source-sans-pro:n2,i2,n3,i3,n4,i4,n6,i6,n7,i7,n9,i9;source-code-pro:n4,n7;volkhov.js"></script>

<meta http-equiv="cleartype" content="on">

<!-- HTML5 Shiv and Media Query Support -->
<!--[if lt IE 9]>
  <script src="https://noaha.net/assets/js/vendor/html5shiv.min.js"></script>
  <script src="https://noaha.net/assets/js/vendor/respond.min.js"></script>
<![endif]-->

<!-- Modernizr -->
<script src="https://noaha.net/assets/js/vendor/modernizr-2.7.1.custom.min.js"></script>


<!-- MathJax -->
<script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>


<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="https://noaha.net/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="https://noaha.net/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="https://noaha.net/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://noaha.net/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://noaha.net/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://noaha.net/images/apple-touch-icon-144x144-precomposed.png">


</head>

<body id="post">

<div class="navigation-wrapper">
	<nav role="navigation" id="site-nav" class="animated drop">
	    <ul>
      
		    
		    <li><a href="https://noaha.net/" >About</a></li>
		  
		    
		    <li><a href="https://noaha.net/publications/" >Publications</a></li>
		  
		    
		    <li><a href="https://noaha.net/projects/" >Projects</a></li>
		  
		    
		    <li><a href="https://noaha.net/teaching/" >Teaching</a></li>
		  
		    
		    <li><a href="https://noaha.net/CV/" >CV / Contact</a></li>
		  
		    
		    <li><a href="https://noaha.net/search/" >Search</a></li>
		  
	    </ul>
	</nav>
</div><!-- /.navigation-wrapper -->

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->

<header class="masthead">
	<div class="wrap">
      
  		<a href="https://noaha.net/" class="site-logo" rel="home" title="Noah P. Allen"><img src="https://noaha.net/images/HeadshotSiteLogo.jpg" width="200" height="200" alt="Noah P. Allen logo" class="animated fadeInDown"></a>
      
      <h1 class="site-title animated fadeIn"><a href="https://noaha.net/">Noah P. Allen</a></h1>
		<h2 class="site-description animated fadeIn" itemprop="description">A Place to Showcase Noah Allen's Work</h2>
	</div>
</header><!-- /.masthead -->

<div class="js-menu-screen menu-screen"></div>


<div id="main" role="main">
  <article class="hentry">
    
    <div class="entry-wrapper">
      <header class="entry-header">
        <ul class="entry-tags">
          
        </ul>
        
          <h1 class="entry-title">Ethernet Controlled Graduated ND Filter</h1>
        
      </header>
      <footer class="entry-meta">
        
        
          <img src="https://noaha.net/images/VTlogo.png" class="bio-photo" alt="Noah Allen bio photo"></a>
        
        <span class="author vcard">By <span class="fn">Noah Allen</span></span>
        <span class="entry-date date published"><time datetime="2018-03-20T12:00:00-04:00"><i class="fa fa-calendar-o"></i> March 20, 2018</time></span>
        <span class="entry-date date modified"><time datetime="2018-03-20 12:00:00 -0400"><i class="fa fa-pencil"></i> March 20, 2018</time></span>
        
        
        
      </footer>
      <div class="entry-content">
        <h2 id="problem">Problem:</h2>

<p class="text-justify">So, after the excitement of fixing the shutter jitter mentioned in the ‘Reverse Engineering the D750 Shutter for Remote Control’ project, I was able to take 
a nice looking SSPC signal from 3 samples but I noticed something interesting.  Ideally, the SSPC signal below should only show slope increases when the incident energy 
is enough to excite trapped charge into the conduction band or out of the valence band but it seemed that the signal could be perturbed by some of the peaks in my 350W 
mercury source.  In order to publish the data this needs to be fixed so that I’m not trying to make conclusions based on faulty data.</p>

<center><img src="/images/projects/SSPCgraph.jpg" align="middle" /></center>

<h2 id="solution">Solution:</h2>

<p class="text-justify">As always, I checked for an existing solution that may be within financial reach but once again found they were much too expensive.  The only thing I needed to do was 
control how much light was able to pass into the end of a fiber optic and quickly found that Newport and ThorLabs sold a circular and rectangular graduated ND filter.  If 
possible I would have liked to use the circular one since attaching it to the end of a stepper motor would have been very easy but they were VERY expensive (&gt;$1K) 
compared to the rectangular ones (~$114).  Since the optics had been selected I only needed to figure out how to slide it in front of the light path.  Having read a lot 
about 3D printers and how open source they have become, I decided to invest in a cheap ($75) stepper controlled linear actuator which I could mount the rectangular ND filter on and 
then slide in front of the optical path.  Below is the linear actuator with the ND filter mounted.</p>

<center><img src="/images/projects/NDfilterSetup.gif" align="middle" /></center>

<p class="text-justify">Once I had the ND filter mounted it was time to setup the hardware so that it could easily be controlled by a LabVIEW program I had running on our main characterization 
computer.  To control the stepper motor I first tried to use a generic L298N board I bought from eBay but quickly learned that an H-bridge wasn’t the most efficient way to 
control a stepper mainly because there was no circuitry to limit the current through each of the stepper coils.  This resulted in saturating the coils with a 12V supply 
when the motor wasn’t moving.  After a little research the DRV8825 Polulu clone from Amazon would be the best solution as far as price and usability.  An Arduino 
seemed like the most sensible choice for quick prototyping but I wasn’t comfortable running a long (&gt;30ft) serial cable across the lab so I decided to acquire a generic 
ENC28J60 board for Ethernet communication.  Below is the circuit I used to interface all three boards boards along with the stepper motor.  NOTE: The ENC28J60 is 5V tolerant 
but requires its own 3.3V power supply.  I used two Buck converters to transform the 12V/2A wall wart to 3.3V and 5V.</p>

<center><img src="/images/projects/NDFilterCircuit.jpg" align="middle" /></center>

<p class="text-justify">The Arduino was programmed to act like a TCP server (using the UIPethernet library) which could be connected to by a LabVIEW running a TCP client program.  The client connects and sends a short string 
which the Arduino server would interpret and either move or return requested data (Arduino program attached at the end).  The next step was to check the range of attenuation 
I could achieve with my new apparatus.  I set the wavelength to 435nm (one of the larger peaks in an Hg lamp spectrum) and moved the ND filter while taking optical intensity 
measurements.  The intensity vs. motor step is shown below.</p>

<center><img src="/images/projects/NDfilterTransmission.jpg" align="middle" /></center>

<p class="text-justify">Finally, I created the algorithm to calculate the motor steps away from the limit switch which would give the correct attenuation value and once again measured the spectrum 
of the Hg lamp.  As you can see below the photon flux at each wavelength is much more consistent but a lot of light power is lost.</p>

<center><img src="/images/projects/SSPCgraphAttenuated.jpg" align="middle" /></center>

<p><br />
<br /></p>

<h1 class="text-center" id="arduino-code">Arduino Code</h1>

<p class="text-justify">The Arduino code is long but pretty simple.  I decided that the speed of moving the ND filter did not matter as much as the resolution so I chose to micro-step at 1/32.  The first 
piece of code I wrote was to reset the stage to a known location.  To accomplish this I quickly stepped the motor until I hit the limit switch at which point I SLOWLY micro-stepped off 
of it until it was no longer depressed and set the current location to ZERO.  Next, I manually moved the stage to a few steps prior to hitting the far side and then I would run the ResetMotor() 
function to check how many steps it would take and found that 138,000 steps was the maximum I could go before hitting the other side.  When testing for backlash and motor slippage I found that 
if I moved the motor &lt;500 steps at full speed it would miss a few so I wrote a check in the MoveSteps() function that would move the motor a little slower for small motor movements.  As 
for the Ethernet code, I basically used the UIPEthernet TCPserver example to setup the ENC28J60 to receive TCP packets and parse the data portion into a String.  From there I just setup 
a few command strings to be recognized (GT, CS, RS, and EN) and then parsed accordingly (ex. GT120000(CR) would go to step 120,000).  NOTE: The only way I could get LabVIEW to connect to the 
ENC28J60 was if I gave it an IP address VERY close to the computer.</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281</pre></td><td class="code"><pre><span class="cm">/* Definition of all of the Ethernet Code
 *  ***********************************************************************
*/</span>
<span class="cp">#include &lt;UIPEthernet.h&gt;
</span>
<span class="n">EthernetServer</span> <span class="n">server</span> <span class="o">=</span> <span class="n">EthernetServer</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
<span class="cm">/*
 *  ***********************************************************************
*/</span>


<span class="cm">/* Definition of all the Stepper Code

*/</span>
<span class="k">const</span> <span class="kt">int</span> <span class="n">SLEEP</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

<span class="k">const</span> <span class="kt">int</span> <span class="n">MODE0</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">int</span> <span class="n">MODE1</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">int</span> <span class="n">MODE2</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>

<span class="k">const</span> <span class="kt">int</span> <span class="kt">DIR</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">int</span> <span class="n">STEP</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>

<span class="k">const</span> <span class="kt">int</span> <span class="n">LIMIT</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

<span class="kt">int</span> <span class="n">stepMode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">long</span> <span class="n">currentStep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="kt">long</span> <span class="n">MaxStep</span> <span class="o">=</span> <span class="mi">138000</span><span class="p">;</span>
<span class="kt">long</span> <span class="n">MinStep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cm">/*
 *  ***********************************************************************
*/</span>

<span class="n">String</span> <span class="n">MessageStr</span> <span class="o">=</span> <span class="s">""</span><span class="p">;</span>


<span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span>
  <span class="cm">/*
   *  ***********************************************************************
  */</span>

  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"Serial Begin"</span><span class="p">);</span>
  <span class="kt">uint8_t</span> <span class="n">mac</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">};</span>
  <span class="n">IPAddress</span> <span class="n">myIP</span><span class="p">(</span><span class="mi">169</span><span class="p">,</span> <span class="mi">254</span><span class="p">,</span> <span class="mi">237</span><span class="p">,</span> <span class="mi">145</span><span class="p">);</span>

  <span class="n">Ethernet</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">myIP</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">"localIP: "</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">Ethernet</span><span class="p">.</span><span class="n">localIP</span><span class="p">());</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">"subnetMask: "</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">Ethernet</span><span class="p">.</span><span class="n">subnetMask</span><span class="p">());</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">"gatewayIP: "</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">Ethernet</span><span class="p">.</span><span class="n">gatewayIP</span><span class="p">());</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">"dnsServerIP: "</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">Ethernet</span><span class="p">.</span><span class="n">dnsServerIP</span><span class="p">());</span>
  <span class="n">server</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"Server Begin"</span><span class="p">);</span>
  <span class="cm">/*
   *  ***********************************************************************
  */</span>
  <span class="n">pinMode</span><span class="p">(</span><span class="n">MODE0</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>
  <span class="n">pinMode</span><span class="p">(</span><span class="n">MODE1</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>
  <span class="n">pinMode</span><span class="p">(</span><span class="n">MODE2</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>
  <span class="n">pinMode</span><span class="p">(</span><span class="kt">DIR</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>
  <span class="n">pinMode</span><span class="p">(</span><span class="n">STEP</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>
  <span class="n">pinMode</span><span class="p">(</span><span class="n">LIMIT</span><span class="p">,</span> <span class="n">INPUT</span><span class="p">);</span>

  <span class="n">digitalWrite</span><span class="p">(</span><span class="kt">DIR</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>
  <span class="n">digitalWrite</span><span class="p">(</span><span class="n">STEP</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>
  <span class="n">digitalWrite</span><span class="p">(</span><span class="n">SLEEP</span><span class="p">,</span> <span class="n">HIGH</span><span class="p">);</span>
  <span class="n">stepMode</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span> <span class="c1">// 1/32 Steps
</span>  <span class="n">SetMode</span><span class="p">(</span><span class="n">stepMode</span><span class="p">);</span> <span class="c1">// 1/32 Steps
</span>  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"Starting Motor Control"</span><span class="p">);</span>
  <span class="n">ResetMotor</span><span class="p">();</span>
  <span class="cm">/*
   *  ***********************************************************************
  */</span>


<span class="p">}</span>

<span class="kt">void</span> <span class="nf">loop</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">size_t</span> <span class="n">size</span><span class="p">;</span>
  <span class="n">String</span> <span class="n">MessageStr2</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">EthernetClient</span> <span class="n">client</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="n">available</span><span class="p">())</span>
  <span class="p">{</span>
    <span class="k">while</span> <span class="p">((</span><span class="n">size</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">available</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="kt">char</span><span class="o">*</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
      <span class="n">size</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
      <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">size</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span><span class="n">MessageStr</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">MessageStr</span> <span class="o">+</span> <span class="n">String</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">msg</span><span class="o">+</span><span class="n">i</span><span class="p">)));}</span>
      <span class="n">free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"Going to Parser"</span><span class="p">);</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">MessageStr</span><span class="p">);</span>
    <span class="n">ParseString</span><span class="p">();</span>
    <span class="n">client</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">MessageStr</span><span class="p">);</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">MessageStr</span><span class="p">);</span>
    <span class="n">client</span><span class="p">.</span><span class="n">stop</span><span class="p">();</span>
    <span class="n">MessageStr</span> <span class="o">=</span> <span class="s">""</span><span class="p">;</span>
  <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">Serial</span><span class="p">.</span><span class="n">available</span><span class="p">()</span><span class="o">!=</span><span class="mi">0</span><span class="p">){</span>
    <span class="n">MessageStr</span> <span class="o">=</span> <span class="n">Serial</span><span class="p">.</span><span class="n">readStringUntil</span><span class="p">(</span><span class="sc">'\n'</span><span class="p">);</span>
    <span class="n">ParseString</span><span class="p">();</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">MessageStr</span><span class="p">);</span>
    <span class="n">MessageStr</span> <span class="o">=</span> <span class="s">""</span><span class="p">;</span>
  <span class="p">}</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ParseString</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">String</span> <span class="n">Message</span> <span class="o">=</span> <span class="n">MessageStr</span><span class="p">;</span>
  <span class="c1">//Serial.println("In Parser");
</span>  <span class="c1">//Serial.println(MessageStr);
</span>  <span class="kt">int</span> <span class="n">StrLen</span> <span class="o">=</span> <span class="n">Message</span><span class="p">.</span><span class="n">length</span><span class="p">();</span>
  <span class="n">String</span> <span class="n">strType</span> <span class="o">=</span> <span class="n">Message</span><span class="p">.</span><span class="n">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
  <span class="n">String</span> <span class="n">strInfo</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="n">StrLen</span><span class="o">&gt;</span><span class="mi">3</span><span class="p">){</span><span class="n">strInfo</span><span class="o">=</span><span class="n">Message</span><span class="p">.</span><span class="n">substring</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">StrLen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);}</span><span class="k">else</span><span class="p">{</span><span class="n">strInfo</span><span class="o">=</span><span class="n">String</span><span class="p">(</span><span class="s">"Null"</span><span class="p">);}</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="s">"Input Length:"</span><span class="o">+</span><span class="n">String</span><span class="p">(</span><span class="n">StrLen</span><span class="p">)));</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="s">"Input Type:"</span><span class="o">+</span><span class="n">strType</span><span class="p">));</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="s">"Input Info:"</span><span class="o">+</span><span class="n">strInfo</span><span class="p">));</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">strType</span> <span class="o">==</span> <span class="s">"GT"</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//GT stands for GoTo step
</span>    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"GoTo Step"</span><span class="p">);</span>
    <span class="n">currentStep</span> <span class="o">=</span> <span class="n">GotoStep</span><span class="p">(</span><span class="n">strInfo</span><span class="p">.</span><span class="n">toInt</span><span class="p">());</span>
    <span class="c1">//Serial.println(strInfo.toInt());
</span>    <span class="n">MessageStr</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="s">"CS"</span> <span class="o">+</span> <span class="n">String</span><span class="p">(</span><span class="n">currentStep</span><span class="p">));</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strType</span> <span class="o">==</span> <span class="s">"RS"</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//RS stands for reset the motor position
</span>    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"Resetting Motor"</span><span class="p">);</span>
    <span class="n">MessageStr</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="s">"RS"</span> <span class="o">+</span> <span class="n">String</span><span class="p">(</span><span class="n">ResetMotor</span><span class="p">()));</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strType</span> <span class="o">==</span> <span class="s">"EN"</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//EN Stands for enabling and disabling the motor
</span>    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"Setting Motor Enable"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">strInfo</span><span class="p">.</span><span class="n">toInt</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">digitalWrite</span><span class="p">(</span><span class="n">SLEEP</span><span class="p">,</span> <span class="n">HIGH</span><span class="p">);</span>
      <span class="n">MessageStr</span> <span class="o">=</span> <span class="s">"ENABLED"</span><span class="p">;</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">digitalWrite</span><span class="p">(</span><span class="n">SLEEP</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>
      <span class="n">MessageStr</span> <span class="o">=</span> <span class="s">"DISABLED"</span><span class="p">;</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strType</span> <span class="o">==</span> <span class="s">"CS"</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"Motor Position"</span><span class="p">);</span>
    <span class="c1">//CS stands for current step
</span>    <span class="n">MessageStr</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="s">"CS"</span> <span class="o">+</span> <span class="n">String</span><span class="p">(</span><span class="n">currentStep</span><span class="p">));</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span><span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strType</span> <span class="o">==</span> <span class="s">"??"</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">MessageStr</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">List of Commands:</span><span class="se">\n</span><span class="s">GT------(CR) | goto step where '-' is a number between 0 and 138000</span><span class="se">\n</span><span class="s">RS(CR)       | Reset Motor [returns # of steps from previous location]</span><span class="se">\n</span><span class="s">EN-(CR)      | where '-' is 0 or 1 for disable or enable</span><span class="se">\n</span><span class="s">CS(CR)       | Returns the current step [CS------]"</span><span class="p">));</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* All of the Code to run the stepper
 *  ***********************************************************************
*/</span>

<span class="kt">void</span> <span class="nf">SetMode</span><span class="p">(</span><span class="kt">int</span> <span class="n">MODE</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">MODE</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="mi">0</span><span class="p">:</span><span class="c1">// Full Step
</span>      <span class="n">digitalWrite</span><span class="p">(</span><span class="n">MODE0</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>
      <span class="n">digitalWrite</span><span class="p">(</span><span class="n">MODE1</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>
      <span class="n">digitalWrite</span><span class="p">(</span><span class="n">MODE2</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mi">1</span><span class="p">:</span><span class="c1">// Half Step
</span>      <span class="n">digitalWrite</span><span class="p">(</span><span class="n">MODE0</span><span class="p">,</span> <span class="n">HIGH</span><span class="p">);</span>
      <span class="n">digitalWrite</span><span class="p">(</span><span class="n">MODE1</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>
      <span class="n">digitalWrite</span><span class="p">(</span><span class="n">MODE2</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mi">2</span><span class="p">:</span><span class="c1">// 1/4 Step
</span>      <span class="n">digitalWrite</span><span class="p">(</span><span class="n">MODE0</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>
      <span class="n">digitalWrite</span><span class="p">(</span><span class="n">MODE1</span><span class="p">,</span> <span class="n">HIGH</span><span class="p">);</span>
      <span class="n">digitalWrite</span><span class="p">(</span><span class="n">MODE2</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mi">3</span><span class="p">:</span><span class="c1">// 1/8 Step
</span>      <span class="n">digitalWrite</span><span class="p">(</span><span class="n">MODE0</span><span class="p">,</span> <span class="n">HIGH</span><span class="p">);</span>
      <span class="n">digitalWrite</span><span class="p">(</span><span class="n">MODE1</span><span class="p">,</span> <span class="n">HIGH</span><span class="p">);</span>
      <span class="n">digitalWrite</span><span class="p">(</span><span class="n">MODE2</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mi">4</span><span class="p">:</span><span class="c1">// 1/16 Step
</span>      <span class="n">digitalWrite</span><span class="p">(</span><span class="n">MODE0</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>
      <span class="n">digitalWrite</span><span class="p">(</span><span class="n">MODE1</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>
      <span class="n">digitalWrite</span><span class="p">(</span><span class="n">MODE2</span><span class="p">,</span> <span class="n">HIGH</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mi">5</span><span class="p">:</span><span class="c1">// 1/32 Step
</span>      <span class="n">digitalWrite</span><span class="p">(</span><span class="n">MODE0</span><span class="p">,</span> <span class="n">HIGH</span><span class="p">);</span>
      <span class="n">digitalWrite</span><span class="p">(</span><span class="n">MODE1</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>
      <span class="n">digitalWrite</span><span class="p">(</span><span class="n">MODE2</span><span class="p">,</span> <span class="n">HIGH</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="nl">default:</span><span class="c1">// Full Step
</span>      <span class="n">digitalWrite</span><span class="p">(</span><span class="n">MODE0</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>
      <span class="n">digitalWrite</span><span class="p">(</span><span class="n">MODE1</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>
      <span class="n">digitalWrite</span><span class="p">(</span><span class="n">MODE2</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span><span class="c1">//END SetMode
</span>
<span class="kt">long</span> <span class="nf">ResetMotor</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"Inside Motor Reset"</span><span class="p">);</span>
  <span class="kt">long</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">digitalWrite</span><span class="p">(</span><span class="kt">DIR</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>
  <span class="n">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">digitalRead</span><span class="p">(</span><span class="n">LIMIT</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">digitalWrite</span><span class="p">(</span><span class="n">STEP</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>
    <span class="n">delayMicroseconds</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
    <span class="n">digitalWrite</span><span class="p">(</span><span class="n">STEP</span><span class="p">,</span> <span class="n">HIGH</span><span class="p">);</span>
    <span class="n">delayMicroseconds</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
    <span class="n">digitalWrite</span><span class="p">(</span><span class="n">STEP</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>
    <span class="n">delayMicroseconds</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
    <span class="n">i</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">digitalWrite</span><span class="p">(</span><span class="kt">DIR</span><span class="p">,</span> <span class="n">HIGH</span><span class="p">);</span>
  <span class="n">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
  <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">digitalRead</span><span class="p">(</span><span class="n">LIMIT</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">digitalWrite</span><span class="p">(</span><span class="n">STEP</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>
    <span class="n">delayMicroseconds</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
    <span class="n">digitalWrite</span><span class="p">(</span><span class="n">STEP</span><span class="p">,</span> <span class="n">HIGH</span><span class="p">);</span>
    <span class="n">delayMicroseconds</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
    <span class="n">digitalWrite</span><span class="p">(</span><span class="n">STEP</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>
    <span class="n">delayMicroseconds</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
    <span class="n">delay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">i</span><span class="o">--</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">//Serial.print("BackFrom: "); Serial.println(i);
</span>  <span class="n">currentStep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span><span class="c1">//End ResetMotor
</span>
<span class="kt">void</span> <span class="nf">MoveSteps</span><span class="p">(</span><span class="kt">long</span> <span class="n">numSteps</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">Delay</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">numSteps</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">500</span><span class="p">){</span><span class="n">Delay</span><span class="o">=</span><span class="mi">0</span><span class="p">;}</span>
  <span class="k">else</span><span class="p">{</span><span class="n">Delay</span><span class="o">=</span><span class="mi">2</span><span class="p">;}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">digitalRead</span><span class="p">(</span><span class="n">LIMIT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">numSteps</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">digitalWrite</span><span class="p">(</span><span class="kt">DIR</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">long</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">abs</span><span class="p">(</span><span class="n">numSteps</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">digitalWrite</span><span class="p">(</span><span class="n">STEP</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>
      <span class="n">delayMicroseconds</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
      <span class="n">digitalWrite</span><span class="p">(</span><span class="n">STEP</span><span class="p">,</span> <span class="n">HIGH</span><span class="p">);</span>
      <span class="n">delayMicroseconds</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
      <span class="n">digitalWrite</span><span class="p">(</span><span class="n">STEP</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>
      <span class="n">delayMicroseconds</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
      <span class="n">delay</span><span class="p">(</span><span class="n">Delay</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">numSteps</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">digitalWrite</span><span class="p">(</span><span class="kt">DIR</span><span class="p">,</span> <span class="n">HIGH</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">long</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">abs</span><span class="p">(</span><span class="n">numSteps</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">digitalWrite</span><span class="p">(</span><span class="n">STEP</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>
      <span class="n">delayMicroseconds</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
      <span class="n">digitalWrite</span><span class="p">(</span><span class="n">STEP</span><span class="p">,</span> <span class="n">HIGH</span><span class="p">);</span>
      <span class="n">delayMicroseconds</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
      <span class="n">digitalWrite</span><span class="p">(</span><span class="n">STEP</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>
      <span class="n">delayMicroseconds</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
      <span class="n">delay</span><span class="p">(</span><span class="n">Delay</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">currentStep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>

<span class="p">}</span><span class="c1">//End MoveSteps
</span>
<span class="kt">long</span> <span class="nf">GotoStep</span><span class="p">(</span><span class="kt">long</span> <span class="n">Step</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Step</span> <span class="o">&gt;</span> <span class="n">MaxStep</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Step</span> <span class="o">=</span> <span class="n">MaxStep</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Step</span> <span class="o">&lt;</span> <span class="n">MinStep</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Step</span> <span class="o">=</span> <span class="n">MinStep</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">MoveSteps</span><span class="p">(</span><span class="n">Step</span> <span class="o">-</span> <span class="n">currentStep</span><span class="p">);</span>
  <span class="n">currentStep</span> <span class="o">=</span> <span class="n">Step</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">Step</span><span class="p">;</span>
<span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

        
      </div><!-- /.entry-content -->
    </div><!-- /.entry-wrapper -->
    <nav class="pagination" role="navigation">
      
        <a href="https://noaha.net/blog/SSPC-Shutter/" class="btn" title="Reverse Engineering the D750 Shutter for Remote Control">Previous</a>
      
      
        <a href="https://noaha.net/blog/Arduino-Compressor/" class="btn" title="LabVIEW Remote Compressor Control">Next</a>
      
    </nav><!-- /.pagination -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo" class="entry-wrapper">
    

<span>&copy; 2019 Noah Allen. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using the <a href="https://mademistakes.com/work/so-simple-jekyll-theme/" rel="nofollow">So Simple Theme</a>.</span>
<div class="social-icons">
	
	
	
	
	
	
	
	
	
  
	
  <a href="https://noaha.net/feed.xml" title="Atom/RSS feed"><i class="fa fa-rss-square fa-2x"></i></a>
</div><!-- /.social-icons -->

  </footer>
</div><!-- /.footer-wrapper -->

<script type="text/javascript">
  var BASE_URL = 'https://noaha.net';
</script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="https://noaha.net/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="https://noaha.net/assets/js/scripts.min.js"></script>





<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-90785511-1', 'auto');
  ga('send', 'pageview');

</script>


</body>
</html>
